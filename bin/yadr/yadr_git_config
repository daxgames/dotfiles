#!/usr/bin/env bash

yadr_gitconfig_disable() {
  [[ -L ~/.gitconfig ]] && rm -f ~/.gitconfig

  [[ ! -L ~/.gitconfig ]] && [[ -e ~/.gitconfig ]] && \
    mv ~/.gitconfig ~/.gitconfig.backup-$(date '+%Y-%m-%d-%H:%M:%S') 2>/dev/null

  [[ -f ~/.gitconfig.user ]] && \
    mv ~/.gitconfig.user ~/.gitconfig 2>/dev/null && \
    trap yadr_gitconfig_restore exit
  echo "==> Disabled YADR framework Git configuration." >&2
}

yadr_gitconfig_restore() {
  [[ -f ~/.gitconfig.user ]] && \
    mv ~/.gitconfig.user ~/.gitconfig.user.bakup-$(date '+%Y-%m-%d-%H:%M:%S') 2>/dev/null

  mv ~/.gitconfig ~/.gitconfig.user
  ln -sf ~/.yadr/git/gitconfig ~/.gitconfig

  echo "==> Restored YADR framework Git configuration." >&2
}

yadr_git_config() {
  yadr_gitconfig_disable

  set -x
  git config $*
  set +x
}

echo $*

if [[ ! -e ~/.gitconfig ]] && [[ -e ~/.yadr/git/gitconfig ]] ; then
  yadr_git_config "$*"
elif [[ -e ~/.yadr/git/gitconfig ]] && [[ -e ~/.gitconfig ]] ; then
  yadr_git_config "$*"
fi
